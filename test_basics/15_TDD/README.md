# 課題15「TDD（テスト駆動開発）でコードを書いてみる」

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<details>
<summary>Table of Contents</summary>

- [課題1](#%E8%AA%B2%E9%A1%8C1)
  - [TDDとは何か](#tdd%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B)
  - [TDDのメリットとデメリットは何か](#tdd%E3%81%AE%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%E3%81%A8%E3%83%87%E3%83%A1%E3%83%AA%E3%83%83%E3%83%88%E3%81%AF%E4%BD%95%E3%81%8B)
  - [レッド・クリーン・リファクタリングとは何か](#%E3%83%AC%E3%83%83%E3%83%89%E3%83%BB%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%83%BB%E3%83%AA%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B)
  - [仮実装](#%E4%BB%AE%E5%AE%9F%E8%A3%85)
  - [三角測量とは何か](#%E4%B8%89%E8%A7%92%E6%B8%AC%E9%87%8F%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B)
- [課題2](#%E8%AA%B2%E9%A1%8C2)
- [質問事項](#%E8%B3%AA%E5%95%8F%E4%BA%8B%E9%A0%85)
- [参考資料](#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99)

</details>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 課題1

### TDDとは何か

TDD（テスト駆動開発）とは以下のシンプルなルールに従う開発手法の1つである。

- 自動化されたテストが失敗した場合にのみ、新しいコードを書く
- 重複を除去する

このルールに従って「きちんと動作する綺麗なコード（Clean code that works）」を目指している。

つまり以下を満たすものである

- Works
  - きちんと動作するコード
    - 要件を満たす
    - バグがない
- Clean
  - 綺麗なコード
    - 可読性
    - 保守性

### TDDのメリットとデメリットは何か

- メリット
  - 先にテストから書くことで、実装後にテストを記載するよりも必要なパターンの漏れが防ぐことができる
  - メインコードとテストコードがセットで増加するため、十分なテストを書きやすくなる
  - テストしずらい設計であることに途中で気づくことができる
    - 自然と高凝集・低結合なクラスを書くようになる
- デメリット
  - TDDの問題ではない（自動テストの問題である）が、テストコードの保守コストがかかる
  - ソフトウェアの品質はあくまでも直行する問題
  - 継続的な開発ではなく、短期的な一発ものの場合はそこまでメリットがなさそ

### レッド・クリーン・リファクタリングとは何か

TDDはレッド・グリーン・リファクタリングのステップで進めていく

- レッド
  - 追加したい次の機能のテストを作成し、失敗させる
- グリーン
  - テストに合格するまでコードを記述し、テストを通す
- リファクタリング
  - コードをリファクタリングする

### 仮実装

TDDはレッド・グリーン・リファクタリングのステップで実装を進めていく開発手法である。

その際、レッドからグリーンにするためにプロダクトコードをどんな手法でも実装してしまい、テストをグリーンにさせることが **仮実装** である。

例えば渡された2つの数字からその掛け算を計算するような関数をTDDで開発する場合、以下のような実装が該当する。

```js
// multiply.test.ts
test("3と2を渡して6が返る", () => {
  const expected = 6;
  const actual = multiply(3, 2);
  expect(actual).toBe(expected);
})

// multiply.ts
const multiply = (arg1: number, arg2: number): number => {
  return 6;
}
```

上記の実装では返り値のみを設定しているが、テスト自体はグリーンになる。

こうすることでテストをグリーンにした状態で、リファクタリングのステップに進めていく手法である。

### 三角測量とは何か

プロダクトコードのリファクタリングを進めていくと、改変したコードがテストの内容をチェックできているか不明な状態になってしまう。

そこで同じテスト対象に対して、異なる観点のテストを追加することで、改変したコードが動作することを確認する手法が **三角測量** である。

先ほどの例では、以下のように1つの結果を検証するだけではなく、他の引数のパターンも検証するといった具合である。

```js
// multiply.test.ts
test("3と2を渡して6が返る", () => {
  const expected = 6;
  const actual = multiply(3, 2);
  expect(actual).toBe(expected);
})

// 三角測量
test("10と-1を渡して6が返る", () => {
  const expected = -10;
  const actual = multiply(10, -1);
  expect(actual).toBe(expected);
})
```

こうした段階的にリファクタリングを進めていく。

## 課題2

以下の仕様を満たすスクリプトを、TDDで開発してみましょう。

- [仕様](https://airtable.com/tblTnXBXFOYJ0J7lZ/viwyi8muFtWUlhNKG/recjXEpChElr4AzCd?blocks=hide)

## 質問事項

- レッドからグリーンまでの実装にどの程度時間をかけているのか
- 仕様書からTDDで開発を進めていくときに、アサーションの粒度はどの程度のするのか何か観点はあったりするでしょうか
  - いきなり仕様書の通りに引数と期待値を実装し始めると、フィードバックループが遅くなりそうです
- TODOは最初の段階でどの程度の洗い出しを行なっているのか
- TODOやテストケースを記載するフォーマットは何かあるのか
- テストケース自体の粒度の切り方の感覚などはどのようなものか
- テストの実行結果がテスト対象の仕様記述になるイメージで書くといい
- テストの実行結果がいけてるようなOSSがあれば知りたい
- TypeScriptでDIコンテナ系のライブラリを使ったりしているのか
- レッド・グリーン・リファクタリングのコミットタイミングにルールなどあるのか
  - t-wadaさんはかなりレッドのタイミングでもコミットしているようです
  - Conventional Commitsのルールに従っている
  - https://www.conventionalcommits.org/ja/v1.0.0/
- プルリクをする際のプラクティスなどありますか（ブランチ運用でも）
- DBとのやりとりをモック化すると自作自演テストが増えがちなので、極力本物のDBを使っているそう
- リポジトリのテストは本物のDBを使用して、リポジトリの使う側はリポジトリのモックを使う

## 参考資料

- 書籍
  - [テスト駆動開発](https://www.amazon.co.jp/%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95%E9%96%8B%E7%99%BA-%EF%BC%AB%EF%BD%85%EF%BD%8E%EF%BD%94%EF%BC%A2%EF%BD%85%EF%BD%83%EF%BD%8B-ebook/dp/B077D2L69C/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&dchild=1&keywords=%E3%83%86%E3%82%B9%E3%83%88%E9%A7%86%E5%8B%95&qid=1615904877&sr=8-1)
- Youtube
  - [TDD Boot Camp 2020 Online #1 基調講演/ライブコーディング](https://youtu.be/Q-FJ3XmFlT8?t=1146)
  - [TDDオンライン勉強会 #1「ライブコーディングで体感する TDD基礎 」(講義編)](https://youtu.be/UhHdnLTxOjE?t=294)
